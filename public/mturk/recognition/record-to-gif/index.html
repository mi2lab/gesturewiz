<!--

Based on:

* http://stackoverflow.com/questions/37838044/record-canvas-drawing-as-animated-gif
* https://zipso.net/sketchpad/sketchpad-lines.html
* https://github.com/antimatter15/jsgif

-->

<html>

<head>
    <title>Gesture Recorder</title>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>
    <script type="text/javascript" src="LZWEncoder.js"></script>
    <script type="text/javascript" src="NeuQuant.js"></script>
    <script type="text/javascript" src="GIFEncoder.js"></script>
    <script type="text/javascript" src="b64.js"></script>

    <script type="text/javascript">
        var ts = function () {
            return (new Date()).getTime();
        };

        // Socket.io

        var room = Math.round(Math.random() * 9999);
        var socket = io();

        socket.on("connect", function () {
            socket.emit("room", room);
        });

        socket.on("answer", function (msg) {
            $("#detected-gesture").html(msg);
        });

        // GIF Encoder stuff

        var encoder;
        var frameStack = [];
        var gifRecordingInterval;
        var gifRecordingStart;
        var pointArray = [];
        var recordingComplete = false;

        var recordPoint = function (isTouch) {
            pointArray.push({
                x: isTouch ? touchX : mouseX,
                y: isTouch ? touchY : mouseY,
                time: ts() - gifRecordingStart
            });
        };

        var startGifRecording = function (mode) {
            if (recordingComplete) {
                return;
            }

            console.log("start GIF recording");

            encoder = new GIFEncoder();
            encoder.setRepeat(0);
            encoder.setDelay(0);
            encoder.start();

            if (mode != 'video') {
                var x = mode == 'touch' ? touchX : mouseX;
                var y = mode == 'touch' ? touchY : mouseY;

                ctx.fillStyle = "black";
                ctx.fillRect(x - LINE_THICKNESS, y - LINE_THICKNESS, 2 * LINE_THICKNESS, 2 * LINE_THICKNESS);

                recordPoint(mode == 'touch');
            }

            gifRecordingStart = ts();

            gifRecordingInterval = window.setInterval(addFrameToGif, 10);
        };

        var stopGifRecording = function () {
            if (recordingComplete) {
                return;
            }

            console.log("stop GIF recording");

            window.clearInterval(gifRecordingInterval);
            encoder.finish();
            recordingComplete = true;

            createOneThirdGesture();
            createTwoThirdsGesture();

            document.getElementById('image-gif').src = 'data:image/gif;base64,' + encode64(encoder.stream().getData());
            document.getElementById('image-png').src = canvas.toDataURL("image/png");
            document.getElementById('point-array').innerHTML = JSON.stringify(pointArray);
        };

        var createOneThirdGesture = function () {
            var l = Math.round(1 / 3 * frameStack.length) - 1;

            ctxCopy.putImageData(frameStack[l], 0, 0);

            document.getElementById('image-png-one-third').src = canvasCopy.toDataURL("image/png");
        };

        var createTwoThirdsGesture = function () {
            var l = Math.round(2 / 3 * frameStack.length) - 1;

            ctxCopy.putImageData(frameStack[l], 0, 0);

            document.getElementById('image-png-two-thirds').src = canvasCopy.toDataURL("image/png");
        };

        var addFrameToGif = function () {
            var video = document.getElementById('camera');
            if (!video.paused)
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height)

            frameStack.push(ctx.getImageData(0, 0, canvas.width, canvas.height));
            encoder.addFrame(ctx);

            socket.emit("gesture", canvas.toDataURL("image/png"));
        };

        // Variables for referencing the canvas and 2dcanvas context
        var canvas, canvasCopy, ctx, ctxCopy;

        // Variables to keep track of the mouse position and left-button status
        var mouseX, mouseY, mouseDown = 0;

        // Variables to keep track of the touch position
        var touchX, touchY;

        // Keep track of the old/last position when drawing a line
        // We set it to -1 at the start to indicate that we don't have a good value for it yet
        var lastX, lastY = -1;

        // some constants
        var LINE_THICKNESS = 5;

        // Draws a line between the specified position on the supplied canvas name
        // Parameters are: A canvas context, the x position, the y position, the size of the dot
        function drawLine(ctx, x, y, size) {

            // If lastX is not set, set lastX and lastY to the current position
            if (lastX == -1) {
                lastX = x;
                lastY = y;
            }

            // Let's use black by setting RGB values to 0, and 255 alpha (completely opaque)
            r = 0;
            g = 0;
            b = 0;
            a = 255;

            // Select a fill style
            ctx.strokeStyle = "rgba(" + r + "," + g + "," + b + "," + (a / 255) + ")";

            // Set the line "cap" style to round, so lines at different angles can join into each other
            ctx.lineCap = "round";
            //ctx.lineJoin = "round";

            // Draw a filled line
            ctx.beginPath();

            // First, move to the old (previous) position
            ctx.moveTo(lastX, lastY);

            // Now draw a line to the current touch/pointer position
            ctx.lineTo(x, y);

            // Set the line thickness and draw the line
            ctx.lineWidth = size;
            ctx.stroke();

            ctx.closePath();

            // Update the last position to reference the current position
            lastX = x;
            lastY = y;
        }

        // Clear the canvas context using the canvas width and height
        function clearCanvas(canvas, ctx) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            document.getElementById('image-gif').src = "";
            document.getElementById('image-png').src = "";
            document.getElementById('image-png-one-third').src = "";
            document.getElementById('image-png-two-thirds').src = "";
            document.getElementById('point-array').innerHTML = "";

            frameStack = [];
            pointArray = [];
            recordingComplete = false;
        }

        // Keep track of the mouse button being pressed and draw a dot at current location
        function sketchpad_mouseDown() {
            startGifRecording();

            mouseDown = 1;
            drawLine(ctx, mouseX, mouseY, LINE_THICKNESS);
        }

        // Keep track of the mouse button being released
        function sketchpad_mouseUp() {
            stopGifRecording();

            mouseDown = 0;

            // Reset lastX and lastY to -1 to indicate that they are now invalid, since we have lifted the "pen"
            lastX = -1;
            lastY = -1;
        }

        // Keep track of the mouse position and draw a dot if mouse button is currently pressed
        function sketchpad_mouseMove(e) {
            // Update the mouse co-ordinates when moved
            getMousePos(e);

            // Draw a dot if the mouse button is currently being pressed
            if (mouseDown == 1) {
                drawLine(ctx, mouseX, mouseY, LINE_THICKNESS);
                recordPoint();
            }
        }

        // Get the current mouse position relative to the top-left of the canvas
        function getMousePos(e) {
            if (!e)
                var e = event;

            if (e.offsetX) {
                mouseX = e.offsetX;
                mouseY = e.offsetY;
            }
            else if (e.layerX) {
                mouseX = e.layerX;
                mouseY = e.layerY;
            }
        }

        // Draw something when a touch start is detected
        function sketchpad_touchStart() {
            // Update the touch co-ordinates
            getTouchPos();
            startGifRecording(true);

            drawLine(ctx, touchX, touchY, LINE_THICKNESS);

            // Prevents an additional mousedown event being triggered
            event.preventDefault();
        }

        function sketchpad_touchEnd() {
            stopGifRecording();

            // Reset lastX and lastY to -1 to indicate that they are now invalid, since we have lifted the "pen"
            lastX = -1;
            lastY = -1;
        }

        // Draw something and prevent the default scrolling when touch movement is detected
        function sketchpad_touchMove(e) {
            // Update the touch co-ordinates
            getTouchPos(e);

            // During a touchmove event, unlike a mousemove event, we don't need to check if the touch is engaged, since there will always be contact with the screen by definition.
            drawLine(ctx, touchX, touchY, LINE_THICKNESS);
            recordPoint(true);

            // Prevent a scrolling action as a result of this touchmove triggering.
            e.preventDefault();
        }

        // Get the touch position relative to the top-left of the canvas
        // When we get the raw values of pageX and pageY below, they take into account the scrolling on the page
        // but not the position relative to our target div. We'll adjust them using "target.offsetLeft" and
        // "target.offsetTop" to get the correct values in relation to the top left of the canvas.
        function getTouchPos(e) {
            if (!e)
                var e = event;

            if (e.touches) {
                if (e.touches.length == 1) { // Only deal with one finger
                    var touch = e.touches[0]; // Get the information for finger #1
                    touchX = touch.pageX - touch.target.offsetLeft;
                    touchY = touch.pageY - touch.target.offsetTop;
                }
            }
        }

        function initVideo() {
            var video = window.video = document.getElementById('camera');

            var constraints = {
                    audio: false,
                    video: true
                },
                camera = -1;

            function gotStream(stream) {
                window.stream = stream; // make stream available to console
                video.srcObject = stream;
            }

            function gotDevices(deviceInfos) {
                window.cameras = [];
                for (var i = 0; i !== deviceInfos.length; ++i) {
                    var deviceInfo = deviceInfos[i];
                    if (deviceInfo.kind === 'videoinput') {
                        cameras.push(deviceInfo.deviceId);
                    }
                }
                console.log('found cameras: ', cameras);
                // pick last camera initially (hopefully rear)
                if (camera == -1) camera = cameras.length - 1;
                var videoSource = window.cameras ? cameras[camera] : undefined;
                var constraints = {
                    audio: false,
                    video: {
                        deviceId: videoSource ? {
                            exact: videoSource
                        } : undefined,
                        width: {
                            exact: 400
                        },
                        height: {
                            exact: 300
                        }
                    }
                };
                return navigator.mediaDevices.getUserMedia(constraints);
            }

            function handleError(error) {
                console.log(error);
            }

            function startVideo() {
                if (window.stream) {
                    window.stream.getTracks().forEach(function (track) {
                        track.stop();
                    });
                };
                navigator.mediaDevices.enumerateDevices().then(gotDevices).then(gotStream).catch(handleError);
            }
            startVideo();
        }

        var gotVideo = false;

        function toggleVideo() {
            if (!gotVideo) {
                initVideo();
                gotVideo = true;
            }

            var video = document.getElementById('camera');
            if (video.paused) {
                video.play();

                startGifRecording(true);
            }
            else {
                video.pause();

                stopGifRecording();
            }
        }

        // Set-up the canvas and add our event handlers after the page has loaded
        function init() {
            // Get the specific canvas element from the HTML document
            canvas = document.getElementById('sketchpad');
            canvasCopy = document.getElementById('sketchpad-copy');

            // If the browser supports the canvas tag, get the 2d drawing context for this canvas
            if (canvas.getContext) {
                ctx = canvas.getContext('2d');
                ctxCopy = canvasCopy.getContext('2d');
            }

            // Check that we have a valid context to draw on/with before adding event handlers
            if (ctx) {
                ctx.fillStyle = "white";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // React to mouse events on the canvas, and mouseup on the entire document
                canvas.addEventListener('mousedown', sketchpad_mouseDown, false);
                canvas.addEventListener('mousemove', sketchpad_mouseMove, false);
                canvas.addEventListener('mouseup', sketchpad_mouseUp, false);

                // React to touch events on the canvas
                canvas.addEventListener('touchstart', sketchpad_touchStart, false);
                canvas.addEventListener('touchend', sketchpad_touchEnd, false);
                canvas.addEventListener('touchmove', sketchpad_touchMove, false);
            }

            document.getElementById('toggle-video').addEventListener('mousedown', toggleVideo);
        }
    </script>

    <style>
        /* Some CSS styling */
        
        #sketchpadapp {
            /* Prevent nearby text being highlighted when accidentally dragging mouse outside confines of the canvas */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .leftside {
            width: 220px;
            height: 285px;
            background-color: #def;
            padding: 10px;
            border-radius: 4px;
        }
        
        .rightside {
            position: absolute;
            left: 240px;
            top: 0px;
        }
        
        #sketchpad {
            float: left;
            height: 300px;
            width: 400px;
            border: 2px solid #888;
            border-radius: 4px;
            position: relative;
            /* Necessary for correct mouse co-ords in Firefox */
        }
        
        #sketchpad,
        #camera {
            position: absolute;
            left: 240px;
            top: 0px;
        }
        
        .btn {
            font-size: 15px;
            padding: 10px;
            -webkit-appearance: none;
            background: #eee;
            border: 1px solid #888;
        }
    </style>
</head>

<body onload="init()">
    <div id="sketchpadapp">
        <div class="leftside">
            <h2>Gesture Definition</h2>
            <br/>
            <br/> Detected gesture: <span id="detected-gesture"></span>
            <br/>
            <br/>
            <input type="submit" value="Clear Sketchpad" id="clearbutton" class="btn" onclick="clearCanvas(canvas,ctx);">
            <br/>
            <br/>
            <button id="toggle-video" class="btn">Video</button>
        </div>
        <div class="rightside">
            <canvas id="sketchpad" height="300" width="400">
            </canvas>
            <canvas id="canvas0" height="300" width="400">
            </canvas>
            <video id="camera" height="300" width="400"></video>
        </div>
    </div>
    <br style="clear: left" />
    <br />
    <img src="" id="image-png-one-third" /><img src="" id="image-png-two-thirds" /><img src="" id="image-png" /><img src="" id="image-gif" />
    <br />
    <br />
    <div id="point-array"></div>
    <canvas id="sketchpad-copy" height="300" width="400" style="position: absolute; left: -9999px; top: -9999px"></canvas>
</body>

</html>